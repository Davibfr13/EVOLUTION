# ğŸ—ï¸ Etapa base: Node com suporte ao Prisma e TSX
FROM node:20-alpine

# ğŸ“‚ Definir diretÃ³rio de trabalho
WORKDIR /app

# âš™ï¸ Copiar apenas os arquivos essenciais para instalar dependÃªncias
COPY package*.json ./

# ğŸ§© Instalar dependÃªncias de produÃ§Ã£o
RUN npm install --production

# ğŸ“¦ Copiar o restante do cÃ³digo
COPY . .

# ğŸ§  Garantir que o schema.prisma exista (baixar se estiver ausente)
RUN if [ ! -f prisma/schema.prisma ] && [ ! -f src/prisma/schema.prisma ] && [ ! -f src/database/prisma/schema.prisma ]; then \
      echo "ğŸ“¥ Baixando schema.prisma padrÃ£o da Evolution API..."; \
      mkdir -p src/database/prisma && \
      wget -q -O src/database/prisma/schema.prisma https://raw.githubusercontent.com/EvolutionAPI/evolution-api/main/src/database/prisma/schema.prisma; \
    else \
      echo "âœ… schema.prisma encontrado localmente."; \
    fi

# âš™ï¸ Detectar e gerar cliente Prisma automaticamente
RUN if [ -f prisma/schema.prisma ]; then \
      npx prisma generate --schema=prisma/schema.prisma; \
    elif [ -f src/prisma/schema.prisma ]; then \
      npx prisma generate --schema=src/prisma/schema.prisma; \
    elif [ -f src/database/prisma/schema.prisma ]; then \
      npx prisma generate --schema=src/database/prisma/schema.prisma; \
    else \
      echo "âŒ Nenhum schema.prisma encontrado!"; exit 1; \
    fi

# ğŸŒ Expor porta padrÃ£o da Evolution API
EXPOSE 8080

# â–¶ï¸ Comando de inicializaÃ§Ã£o
CMD ["npm", "start"]
